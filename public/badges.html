<html><head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçª</text></svg>">
  <title>üç∫ Badges</title>
  <link rel="stylesheet" href="style.css">
</head><body>
  <h1 id="title">
    <select id="selectRetired" onchange="filterTable()">
      <option value="all">All</option>
      <option value="active">Active</option>
      <option value="retired">Retired</option>
    </select>
    Badges, from
    <select id="selectUserHas" onchange="filterTable()">
      <option value="all">everyone</option>
    </select>
    missing for
    <select id="selectUserNot" onchange="filterTable()">
      <option value="all">nobody</option>
    </select>
  </h1>
  
  <table><thead><tr></tr></thead><tbody></tbody></table>
  <script>
    let badges = [];

    fetch("/data/badges.json")
      .then((response) => response.json())
      .then((data) => {
        badges = data;
        createHeader(badges.users);
        createRows(badges);
      });

    function createHeader(users) {
      const row = document.querySelector("thead tr")
      row.appendChild(createElement("th", "Badge"));
      users.forEach((user) => row.appendChild(createElement("th", `${user.displayname} (${user.uniquebadges})`)));

      const selectUserHas = document.getElementById("selectUserHas");
      users.forEach((user) => selectUserHas.appendChild(createOption(user.name, user.displayname)));

      const selectUserNot = document.getElementById("selectUserNot");
      users.forEach((user) => selectUserNot.appendChild(createOption(user.name, user.displayname)));
    }

    function filterTable() {
      const retired = document.getElementById("selectRetired").value;
      const retiredMatches = (badge) => (retired === "all" || (retired === "active" && !badge.isRetired) || (retired === "retired" && badge.isRetired));
      const userHas = document.getElementById("selectUserHas").value;
      const userHasMatches = (badge) => userHas === "all" || badge.users.find((b) => b.name === userHas);
      const userNot = document.getElementById("selectUserNot").value;
      const userNotMatches = (badge) => userNot === "all" || !badge.users.find((b) => b.name === userNot);

      const table = document.querySelector("tbody");
      table.innerHTML = "";
      createRows({
        list: badges.list.filter((badge) => retiredMatches(badge) && userHasMatches(badge) && userNotMatches(badge)),
        users: badges.users
      });
    }

    function filterTable2() {
      const selectRetired = document.getElementById("selectRetired");
      const selectUserHas = document.getElementById("selectUserHas");
      const selectUserNot = document.getElementById("selectUserNot");
      const rows = document.querySelectorAll("tbody tr");
      rows.forEach((row) => {
        const badge = row.querySelector("td").innerText;
        const retired = badge.includes("(retired)");
        const userHas = selectUserHas.value;
        const userNot = selectUserNot.value;
        row.style.display = (selectRetired.value === "all" || (selectRetired.value === "active" && !retired) || (selectRetired.value === "retired" && retired)) &&
          (userHas === "all" || row.querySelector(`td:nth-child(${Array.from(row.parentNode.rows).indexOf(row) + 2})`).innerText.includes(userHas)) &&
          (userNot === "all" || !row.querySelector(`td:nth-child(${Array.from(row.parentNode.rows).indexOf(row) + 2})`).innerText.includes(userNot)) ? "" : "none";
      });
    }

    function createRows(badges) {
      const table = document.querySelector("tbody");
      badges.list.forEach((badge) => {
        const row = document.createElement("tr");
        row.appendChild(createElement("td", `<img src="${badge.image}" /> ${badge.name}${badge.isRetired ? " (retired)" : ""}`));
        badges.users.forEach((user) => {
          const userBadge = badge.users.find((b) => b.name === user.name);
          if (userBadge) {
            const date = userBadge.date ? userBadge.date.split("T")[0] : "‚úì";
            const level = badge.isLevel ? ` (Level ${userBadge.level ? userBadge.level : "1"})` : "";
            row.appendChild(createElement("td", date + level));
          } else {
            row.appendChild(createElement("td", ""));
          }
        });
        table.appendChild(row);
      });
    }

    function createElement(tag, content) {
      const element = document.createElement(tag);
      element.innerHTML = content;
      return element;
    }

    function createOption(value, text) {
      const option = document.createElement("option");
      option.value = value;
      option.innerHTML = text;
      return option;
    }
  </script>
</body></html>
